# Стресс-тестирование WebSocket сервера

Этот набор инструментов предназначен для стресс-тестирования WebSocket сервера в Docker-кластере и определения максимальной нагрузки, которую может выдержать система.

## Компоненты

1. **stress-test.js** - основной скрипт для стресс-тестирования, который эмулирует множество одновременных пользователей
2. **monitor-resources.js** - скрипт для мониторинга ресурсов системы и Docker-контейнеров
3. **analyze-results.js** - скрипт для анализа результатов тестирования
4. **run-stress-test.sh** - скрипт для автоматического запуска всего процесса
5. **setup-limited-resources.sh** - скрипт для запуска контейнеров с ограниченными ресурсами

## Предварительные требования

- Node.js 14+ 
- Docker и Docker Compose
- Запущенные контейнеры: backend, postgres, redis

## Порядок проведения стресс-теста

### Конфигурация с ограниченными ресурсами

Чтобы получить более точные результаты тестирования и обеспечить стабильное распределение ресурсов, рекомендуется запустить контейнеры с фиксированными ограничениями по CPU и памяти:

```bash
# Из директории stress
./setup-limited-resources.sh
```

Этот скрипт:
1. Останавливает текущие контейнеры
2. Запускает их с ограничениями ресурсов, используя docker-compose-limited.yml
3. Проверяет, что все контейнеры запущены успешно

Контейнеры запускаются со следующими ограничениями (25% от общего объема ресурсов системы):
- Backend: 4 ядра CPU, 2GB RAM
- PostgreSQL: 1 ядро CPU, 1GB RAM
- Redis: 0.5 ядра CPU, 256MB RAM
- И другие сервисы с соответствующими ограничениями

### Настройка параметров теста

Перед запуском теста вы можете изменить следующие параметры в файле `stress-test.js`:

```javascript
const TEST_CONFIG = {
  serverUrl: 'http://localhost:4000',        // URL WebSocket сервера
  connectionsPerWorker: 100,                 // Количество соединений на каждый воркер
  messageInterval: 2000,                     // Интервал отправки сообщений в мс
  testDuration: 120000,                      // Продолжительность теста в мс
  rampUpPeriod: 30000,                       // Период постепенного увеличения нагрузки в мс
  numCPUs: os.cpus().length,                 // Количество воркеров (по умолчанию = количеству ядер CPU)
  initialDelayBetweenConnections: 50         // Начальная задержка между созданием соединений
};
```

Чтобы изменить список контейнеров для мониторинга, отредактируйте файл `monitor-resources.js`:

```javascript
const MONITOR_CONFIG = {
  interval: 2000,                           // Интервал сбора метрик в мс
  outputFile: path.join(__dirname, 'stress-test-metrics.json'),   // Файл для сохранения результатов
  csvFile: path.join(__dirname, 'stress-test-metrics.csv'),       // CSV файл для анализа
  duration: 180000,                         // Продолжительность мониторинга в мс
  dockerContainers: ['backend', 'postgres', 'redis'] // Контейнеры для мониторинга
};
```

### Запуск теста

Для запуска стресс-теста выполните:

```bash
# Из директории stress
./run-stress-test.sh
```

Скрипт автоматически:
1. Проверит наличие необходимых контейнеров
2. Установит зависимости
3. Запустит мониторинг ресурсов
4. Запустит стресс-тест
5. После завершения теста запустит анализ результатов

### Анализ результатов

Результаты стресс-теста сохраняются в следующих файлах:
- `stress-test-metrics.json` - полные метрики в формате JSON
- `stress-test-metrics.csv` - метрики в формате CSV для импорта в Excel или Grafana

Скрипт анализа `analyze-results.js` автоматически определит:
- Максимальную и среднюю нагрузку на CPU и память для системы и каждого контейнера
- Узкие места системы (контейнеры с высокой нагрузкой)
- Оценку максимального количества одновременных пользователей
- Рекомендации по улучшению производительности

Чтобы запустить анализ отдельно:

```bash
node analyze-results.js
```

## Интерпретация результатов

Скрипт анализа выдаст рекомендации на основе собранных метрик. Обычно ограничивающим фактором является:

1. **CPU**: Если нагрузка на CPU в каком-либо контейнере превышает 80%
2. **Память**: Если использование памяти превышает 80%

Если ни один из ресурсов не достиг предела, рекомендуется увеличить нагрузку в тесте, чтобы определить максимальную емкость системы.

## Рекомендации по масштабированию

Основываясь на результатах теста, возможны следующие стратегии масштабирования:

1. **Вертикальное масштабирование**: Увеличение ресурсов для контейнеров, которые показывают высокую нагрузку
2. **Горизонтальное масштабирование**: Создание нескольких экземпляров backend с балансировщиком нагрузки
3. **Оптимизация кода**: Улучшение производительности критических частей приложения
4. **Кэширование**: Увеличение использования Redis для кэширования данных

## Устранение неполадок

Если при запуске теста возникают ошибки, проверьте:

1. Работают ли все необходимые Docker-контейнеры
2. Правильно ли настроены URL и порты в конфигурации
3. Достаточно ли системных ресурсов для проведения теста

При проблемах с подключением к WebSocket серверу проверьте логи контейнера backend:

```bash
docker logs backend
```

### Проблемы сохранения метрик

Если скрипт анализа не может найти файл с метриками `stress-test-metrics.json`, проверьте наличие резервных копий:

1. `stress-test-metrics.json.temp` - временная копия метрик
2. `stress-test-metrics-backup.json` - резервная копия

Вы можете вручную скопировать один из этих файлов:

```bash
cp stress-test-metrics.json.temp stress-test-metrics.json
# или
cp stress-test-metrics-backup.json stress-test-metrics.json
``` 